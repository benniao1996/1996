
<!-- saved from url=(0030)https://github.com/benniao1996/1996/index.html -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <style type="text/css">
    BODY {
     color: #fff;
     background: #000;
     font-family: sans-serif;
     margin-left: 3%;
     margin-right: 3%;
    }
    </style>
</head>
<body>
<font color="chartreuse">
<pre>
                .-~~~~~~~~~-._       _.-~~~~~~~~~-.
            __.'              ~.   .~              `.__
          .'//                  \./                  \\`.
        .'//                     |                     \\`.
      .'// .-~"""""""~~~~-._     |     _,-~~~~"""""""~-. \\`.
    .'//.-"                 `-.  |  .-'                 "-.\\`.
  .'//______.============-..   \ | /   ..-============.______\\`.
.'______________________________\|/______________________________`.
系统优化

1.修改ip
[root@localhost ~]# vi /etc/sysconfig/network-scripts/ifcfg-eth0
DEVICE=eth0         #网卡名字
BOOTPROTO=static    #静态IP地址获取状态 如：DHCP表示自动获取IP地址
IPADDR=192.168.1.113            #IP地址
NETMASK=255.255.255.0           #子网掩码
ONBOOT=yes#引导时是否激活
GATEWAY=192.168.1.1
[root@localhost ~]# cat /etc/sysconfig/network-scripts/ifcfg-eth0
DEVICE=eth0
BOOTPROTO=static
IPADDR=192.168.1.113
NETMASK=255.255.255.0
ONBOOT=yes
GATEWAY=192.168.1.1
[root@localhost ~]# vi /etc/sysconfig/network
HOSTNAME=c64     #修改主机名，重启生效
GATEWAY=192.168.1.1    #修改默认网关,如果上面eth0里面不配置网关的话，默认就使用这里的网关了。
[root@localhost ~]# cat /etc/sysconfig/network
HOSTNAME=c64
GATEWAY=192.168.1.1

2.修改DNS
[root@localhost ~]# vi /etc/resolv.conf   #修改DNS信息
nameserver 114.114.114.114
nameserver 8.8.8.8
[root@localhost ~]# cat /etc/resolv.conf  #查看修改后的DNS信息
nameserver 114.114.114.114
nameserver 8.8.8.8
[root@localhost ~]# service network restart   #重启网卡，生效
重启网卡，也可以用下面的命令
[root@localhost ~]# /etc/init.d/network restart

3.修改主机名
[root@localhost ~]# hostnamectl set-hsotname ip-where-work

4.Centos7-重建yum源
#!/bin/bash
cat > Base.repo.sh << "EOF"
yum -y install wget
mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup
wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
yum clean all
yum makecache
EOF
echo "重建yum源脚本写入成功"
echo "脚本执行中"
sh Base.repo.sh

5.关闭selinux防火墙
默认云服务器都是关着的
sed -i "s/=enforcing/=disabled/g" /etc/selinux/config

6.修改防火墙iptables
CentOS切换为iptables防火墙
firewall-cmd --state 查看防火墙状态
切换到iptables首先应该关掉默认的firewalld，然后安装iptables服务。
1、关闭firewall：
systemctl stop firewalld.service 
systemctl disable firewalld.service #禁止firewall开机启动
2、安装iptables防火墙
yum install iptables-services #安装
service iptables save
3、编辑iptables防火墙配置
vi /etc/sysconfig/iptables #编辑防火墙配置文件
下边是一个完整的配置文件：
systemctl start iptables.service  #开启
systemctl enable iptables.service #设置防火墙开机启动

#!/bin/bash
cat > fwiptables.sh << "EOF"
#!/bin/bash
#fwiptables
IPT=`which iptables`
$IPT -F
$IPT -X
$IPT -P INPUT DROP
$IPT -P FORWARD ACCEPT
$IPT -P OUTPUT ACCEPT
$IPT -N syn-flood
##本地回环 内网允许任何
$IPT -A INPUT -i lo -j ACCEPT
$IPT -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
$IPT -A INPUT -m state --state NEW -s 10.0.0.0/8 -j ACCEPT
# ssh 端口开放
$IPT -A INPUT -m state --state NEW -p tcp --dport 23333 -m comment --comment "ssh 端口" -j ACCEPT
# 根据需求填写相应的端口
$IPT -A INPUT -p tcp -m multiport --dports 80,443 -m comment --comment "网页ssl端口 " -j ACCEPT
# zabbix监控地址
$IPT -A INPUT -p tcp -m state --state NEW -m tcp --dport 10050 -m comment --comment "zabbix监控" -j ACCEPT
# 58138
#$IPT -A INPUT -p tcp -m state --state NEW -m tcp --dport 58138 -m comment --comment "自定义业务端口" -j ACCEPT
# mysql 端口
$IPT -A INPUT -p tcp -m state --state NEW -m tcp --dport 3306 -m comment --comment "mysql 端口" -j ACCEPT
# mongod 端口
$IPT -A INPUT -p tcp -m state --state NEW -m tcp --dport 27017 -m comment --comment "mongod 端口" -j ACCEPT
# redis 端口
$IPT -A INPUT -p tcp -m state --state NEW -m tcp --dport 6379 -m comment --comment "redis 端口" -j ACCEPT
# 局域网 访问
#$IPT -A INPUT -p tcp -s 192.168.1.0/24 -m comment --comment "局域网" -j ACCEPT
# 公网 访问
$IPT -A INPUT -p tcp -s 111.111.111.0/24 -m comment --comment "公网" -j ACCEPT
#$IPT -A INPUT -p tcp -s 321.321.321.0/24 -m comment --comment "公网2" -j ACCEPT
#$IPT -A INPUT -p tcp -s 123.123.123.0/24 -m comment --comment "公网3" -j ACCEPT

# 以下规则是屏蔽以 youtube.com 为主的所有一级 二级 三级等域名。
#iptables -A OUTPUT -m string --string "youtube.com" --algo bm --to 65535 -j DROP
#$IPT -A OUTPUT -m string --string "6x66.com" --algo bm --to 65535 -j DROP
#$IPT -A OUTPUT -m string --string "2s11.com" --algo bm --to 65535 -j DROP
#$IPT -A OUTPUT -m string --string "aresboot.com" --algo bm --to 65535 -j DROP
# 添加屏蔽规则
#iptables -D OUTPUT -m string --string "youtube.com" --algo bm --to 65535 -j DROP
# 删除屏蔽规则，上面添加的代码是什么样，那么删除的代码就是把 -A 改成 -D

# ICMP 规则控制
$IPT -A INPUT -p icmp -m limit --limit 100/sec --limit-burst 100 -j ACCEPT
$IPT -A INPUT -p icmp -m limit --limit 1/s --limit-burst 10 -j ACCEPT
# DOS防护
$IPT -A INPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -j syn-flood
$IPT -A INPUT -j REJECT --reject-with icmp-host-prohibited
$IPT -A syn-flood -p tcp -m limit --limit 3/sec --limit-burst 6 -j RETURN
$IPT -A syn-flood -j REJECT --reject-with icmp-port-unreachable
$IPT -L
service iptables save
EOF
echo "fwiptables脚本写入成功"
echo "脚本执行中"
chmod +x fwiptables.sh && cp fwiptables.sh /root/ && sh /root/fwiptables.sh

7.权限密钥
一，ssh建立链接过程
1.服务器上产生公钥
2.客户端带着私钥访问服务器
3.服务器上公钥返回给客户端，并且用自己的公钥和客户端发来的私钥生成key pair
4.客户端再次带着自己的私钥和服务器发来的公钥生成key pair访问服务器
5.服务器用自己的key pair和客户端的key pair进行比对，建立链接
注意：
在第一次链接的时候，会在本地生成密钥文件/.ssh/known_hosts(可以存放多个)

二，ssh生成密钥对过程
1.客户端 ssh-keygen -t dsa
生成2个文件，id_dsa(私钥)，id_dsa_pub(公钥)
2.客户端 发送公钥到服务器端
3.客户端 带着公钥发送链接请求
4.验证公钥
5.服务器 用公钥加密质询，发送至客户端
6.客户端 用私钥解密质询
7.客户端 将解密后的质询发送回服务器
8.服务器 验证质询
9.验证通过，链接建立

三，sshd_config配置文件可修改地方
1.#Port 22
2.PermitRootLogin yes  默认是打开的，就是允许客户端用root链接
3.#PermitEmptyPasswords no 是否允许空密码
下面是可以解决链接慢
1.UseDNS no 拒绝域名解析
2.GSSAPICleanupCredentials no

四，客户端链接ssh基本语法
1.指定端口的链接，会跳到链接的机子上
ssh -p22 user@ip -p指定端口，默认即位22
2.在链接的机子上执行命令，不会跳到链接的机子上
ssh -p22 user@ip command

五，基于ssh加密的scp命令
1.推：scp -P22 /etc/file user@ip:/tmp -P这个指定端口是大写p
2.拉：scp -P22 user@ip:/tmp/file /etc/
3.参数介绍：
-r递归，表示拷贝目录
-p表示拷贝前后保持文件目录属性
-l limit限制速度
通常scp -P22 -rp 即可
4.scp每次都是全量的拷贝，不同于rsync的增量

非交互式创建密钥
我们手动创建是通过,ssh-keygen -t dsa，然后回车
1.自动创建
ssh-keygen -t dsa -P '' -f ~/.ssh/id_dsa > /dev/null 2>&1
2.将公钥发送到远程主机
ssh-copy-id -i .ssh/id_dsa.pub "-p22 user@ip"
发送过去后，远程主机会产生.ssh/authorized_keys文件，权限是600，本地会多出.ssh/known_hosts文件
提权执行
1.直接root账号，将sshd_config里面允许root登录
2.sudo提权实现没有权限的用户拷贝
首先，配置sudoers:
终端命令；visudo，相当于配置/etc/sudoers
## Allow root to run any commands anywhere
用户或者组   机器=授权角色  可执行命令
root    ALL=(ALL)       ALL
joker   ALL=(ALL)       /usr/bin/rsync
@group  ALL=(ALL)       ALL
user    ALL=(ALL)       NOPASSWD:ALL
解释：
第一个ALL代表机器，就是所有机器，第二个ALL代表所有角色，第三个ALL代表可以执行所有命令，NOPASSWD代表提权命令时不需要提示密码
然后，加载sudoers文件
visudo -C
最后，用joker用户通过基于ssh的rsync发送文件
用户或者组在执行授权的特殊权限命令时后格式为sudo 命令，切换到root格式为 sudo su - ，需要输入当前用户的密码，而不是root密码
ssh -p22 -t user@ip sudo rsync ~/hosts /etc/hosts
注意；
如果，提示命令找不到，很可能是环境变量导致
root下，echo $path
user下，echo $path
在user下，修改vi ~/.bash_profile，将/usr/local/sbin:/sbin:/usr/sbin加入进去
3.利用suid实现没有权限用户拷贝（了解即可）
chmod u+s 'which rsync'
附赠基于ssh的scp推送脚本

#!/bin/bash
if [ $# -ne 2 ];then
    echo "usage:/bin/bash $0 {avg1 avg2}"
    exit 1
fi
. /etc/init.d/functions
for ip in 1 2 3
do
scp -p22 file user@ip:/tmp > /dev/null 2&1
if [ $? -eq 0 ];then
    action "fenfa hosts ip" /bin/true
else
    action "fenfa hosts ip" /bin/false
fi
done

非交互模式产生密钥

1.yum install expect -y
2.mkpasswd -l 10
参数介绍，生成随机字符串，-l是指生成多少个字符
3.简单介绍expect的过程
首先，还是需要手动ssh-keygen生成私钥，公钥
然后，spawn ssh-copy-id -i id_dsa.pub "-p 22 user@ip"
     expect {
         "yes/no" {send "yes\r":exp_continue}
         "*password" {send "123\r"}
     }
     expect eof

附赠基于expect免密钥分发脚本

#!/bin/bash
# The author is joker, which is used to manage the host.
expect_order=`which expect 1>/dev/null 2>&1`
if [ $? -eq 1 ];then
    yum install expect -y
    sleep 1
    sh $0
else
    Distribute(){
    for IP in $(cat /service/script/distribute_ip.txt);do
        Passwd=$1
        USER=$2
        expect -c "
            spawn ssh-copy-id -i /root/.ssh/id_rsa.pub -p 22 $USER@$IP
                expect {
                    \"*yes/no*\" {send \"yes\r\"; exp_continue}
                    \"*password*\" {send \"$Passwd\r\";exp_continue}
                    \"*password*\" {send \"$Passwd\r\";}
            }
        "
        if [ $? -eq 0 ];then
            echo -e "\033[32m 绿色字,ssh $IP 链接成功 \033[0m"
        else
            echo -e "\033[31m 红色字,ssh $IP 链接失败，请检查原因 \033[0m"
        fi
    done
    }
    Distribute "Poppy1115" root
fi
###########################################
# distribute_ip.txt，注意该文件适合在同一个地区使用，内网互动,否则去除内网地址
# 外网地址 内网地址

8.服务器时间和时区
修改时区
1)使用tzselect设置时区
2)复制相应的时区文件，替换系统默认时区
  cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
3)将当前时间写入BIOS永久生效（避免重启后失效）
  hwclock
4)centos /etc/sysconfig/clock
  ubuntu /etc/timezone

一．ntp服务搭建

1.安装软件

yum install ntp     #服务器程序

yum install ntpdate  #自动更新时间服务

2.启动服务

chkconfig --level 35 ntpd on  

chkconfig --level 35 ntpdate on  

service ntpd start
#ntpd服务不能和ntpdate服务同时启动

service ntpdate stop
# ntpd服务不能和ntpdate服务同时启动
ntpd与ntpdate在更新时间时是有的区别。ntpd不仅仅是时间同步服务器，他还可以做客户端与标准时间服务器进行同步时间，而且是平滑同步，并非ntpdate立即同步，在生产环境中慎用ntpdate，也正如此两者不可同时运行。

3.确认时间同步

ntptime && date && hwclock --show && date +"%Y-%m-%d %H:%M:%S"

d<字符串>：显示字符串所指的日期与时间。字符串前后必须加上双引号；
date -d "1 day ago" +"%Y-%m-%d"     ago是昨天
date -d "1 day" +"%Y-%m-%d"         不加参数是明天
以下使用数字表示前后多少天的加减
date +%Y%m%d #显示前天年月日 
date -d "+1 day" +%F   #显示前一天的日期  %F就是%Y-%m-%d
date -d "-1 day" +%F   #显示后一天的日期   
date -d "-1 month" +F  #显示上一月的日期 
date -d "+1 month" +F  #显示下一月的日期 
date -d "-1 year" +F   #显示前一年的日期 
date -d "+1 year" +F   #显示下一年的日期

-s<字符串>：根据字符串来设置日期与时间。字符串前后必须加上双引号； 
date -s 01:01:01 #设置具体时间，不会对日期做更改 
date -s "01:01:01 2012-05-23" #这样可以设置全部时间 
date -s "01:01:01 20120523"   #这样可以设置全部时间 
date -s "2012-05-23 01:01:01" #这样可以设置全部时间 
date -s "20120523 01:01:01"   #这样可以设置全部时间

默认云服务器有同步的时间服务器
修改时间 date
硬件时间 hwclock --show
同步公有时间服务器，可搭配任务计划，阿里云的时间服务器ntp.aliyun.com
yum -y install ntp ntpdate
chkconfig --level 35 ntpd on
chkconfig --level 35 ntpdate on
service ntpd start
service ntpdate stop
ntptime
注意；如果出现ntpdate[24325]: the NTP socket is in use, exiting，需要systemctl stop ntpd.service停止，然后同步，之后再启动，阿里云服务器默认同步阿里云时间服务器

附赠当前任务的执行时间脚本
#!/bin/bash
start=$(date +%s)   # 1528437613
nmap man.linuxde.net &> /dev/null
end=$(date +%s)
difference=$(( end - start ))
echo $difference seconds.

任务计划使用
cat /var/spool/cron/root 可直接修改配置文件，注意重启／reload
crontab -e
crontab -l -u root #查看root用户
基本格式 :
*　　*　　*　　*　　*　　command
分　 时　 日　 月　 周　 命令
第1列表示分钟1～59 每分钟用*或者 */1表示
第2列表示小时1～23（0表示0点）
第3列表示日期1～31
第4列表示月份1～12
第5列标识号星期0～6（0表示星期天）
第6列要运行的命令
每月1、10、22日的4 : 45重启apache
45 4 1,10,22 * * /usr/local/etc/rc.d/lighttpd restart
每天18 : 00至23 : 00之间每隔30分钟重启apache
0,30 18-23 * * * /usr/local/etc/rc.d/lighttpd restart
每月的4号与每周一到周三的11点重启apache
0 11 4 * mon-wed /usr/local/etc/rc.d/lighttpd restart
晚上11点到早上7点之间，每隔一小时重启apache
* 23-7/1 * * * /usr/local/etc/rc.d/lighttpd restart

9.修改系统启动服务
systemctl 是管制服务的主要工具,它整合了chkconfig 与 service功能于一体。

systemctl is-enabled iptables.service
#查询防火墙是否开机启动

systemctl restart sshd
#有可能不需要加service

systemctl is-enabled XXX.service
#查询服务是否开机启动

systemctl enable XXX.service
#开机运行服务

systemctl disable XXX.service
#取消开机运行

systemctl start XXX.service
#启动服务

systemctl stop XXX.service
#停止服务

systemctl restart XXX.service
#重启服务

systemctl reload XXX.service
#重新加载服务配置文件 (改完配置文件需要重载才生效)

systemctl status XXX.service
#查询服务运行状态

systemctl --failed
#显示启动失败的服务

10.清理磁盘垃圾node节点
centos7默认安装了postfix邮件服务，因此邮件位置 /var/spool/postfix/maildrop/会存在垃圾文件，如果长时间不清理，会导致inode数量不够用，从而无法存放文件

11.修改系统字符编码支持中文
修改字符编码，默认是LANG=en_US.UTF-8
修改该文件之前，可以先查看已经安装的语言包：
locale -a | grep zh
可通过grep过滤查看是否有中文语言包
如果没有语言包

yum -y install kde-l10n-Chinese glibc-common

安装完成后通过vi命令编辑配置文件
vim /etc/locale.conf
LANG="zh_CN.UTF-8"
source /etc/locale.conf

12.隐藏内核信息
# cat /etc/redhat-release 

CentOS Linux release 7.7.1908 (Core)

echo 'Windows XP benniao (笨鸟)' > /etc/redhat-release

Windows XP benniao (笨鸟)
# cat /etc/issue
\S
Kernel \r on an \m

13.锁定关键核心目录
加锁，不可修改加锁文件
[root@jokerpro ~]# chattr +i /etc/passwd /etc/resolv.conf /etc/sudoers /etc/ssh/sshd_config
[root@jokerpro ~]# lsattr /etc/passwd /etc/resolv.conf /etc/sudoers /etc/ssh/sshd_config
----i----------- /etc/passwd
----i----------- /etc/resolv.conf
----i----------- /etc/sudoers
----i----------- /etc/ssh/sshd_config
去锁，可以修改文件
[root@jokerpro ~]# chattr -i /etc/passwd 
[root@jokerpro ~]# lsattr /etc/passwd   
-------------e-- /etc/passwd

14.免疫死亡之ping
# 开启禁止ping
echo "net.ipv4.icmp_echo_ignore_all=1"  1>> /etc/sysctl.conf && sysctl -p
# 关闭禁止ping
首先要删除 /etc/sysctl.conf 里面net.ipv4.icmp_echo_ignore_all = 1
之后执行如下命令
echo 0 1> /proc/sys/net/ipv4/icmp_echo_ignore_all
# 后续就可以通过更改 cat  /proc/sys/net/ipv4/icmp_echo_ignore_all文件
关闭 1 开启

15.历史记录操作
# 以下都是临时生效，默认1000不需要更改
# 设置的是闲置账号的超时时间
export TMOUT=10 10秒后提示超时时间
# 设置终端history显示条数
export HISTSIZE=5 只显示最近5条信息
# 上面的终端显示对应的是 cat ~/.bash_history 
export HISTFILESIZE=5 该文件只保存5条信息
# 清空历史记录
history -c
# 指定条数删除
history -d 历史记录条属




</o_></pre>
</font>
<svg class="fatkun-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5892"><path d="M494.933333 782.933333c2.133333 2.133333 4.266667 4.266667 8.533334 6.4h8.533333c6.4 0 10.666667-2.133333 14.933333-6.4l2.133334-2.133333 275.2-275.2c8.533333-8.533333 8.533333-21.333333 0-29.866667-8.533333-8.533333-21.333333-8.533333-29.866667 0L533.333333 716.8V128c0-12.8-8.533333-21.333333-21.333333-21.333333s-21.333333 8.533333-21.333333 21.333333v588.8L249.6 475.733333c-8.533333-8.533333-21.333333-8.533333-29.866667 0-8.533333 8.533333-8.533333 21.333333 0 29.866667l275.2 277.333333zM853.333333 874.666667H172.8c-12.8 0-21.333333 8.533333-21.333333 21.333333s8.533333 21.333333 21.333333 21.333333H853.333333c12.8 0 21.333333-8.533333 21.333334-21.333333s-10.666667-21.333333-21.333334-21.333333z" p-id="5893"></path></svg>
</body>
</html>
